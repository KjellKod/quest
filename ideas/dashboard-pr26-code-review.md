# Code Review: PR #26 — Quest Dashboard

**PR:** KjellKod/quest#26 | **Branch:** `master-dashboard` → `main` | **+4738 / -6**

## Overall Assessment

This is a well-structured PR that delivers a self-contained static HTML dashboard generator. The architecture is clean (models/loaders/render separation), the test coverage is solid (29 tests), and the generated HTML is fully self-contained with no external dependencies. The synthesis of three prior implementations is well done.

**Verdict: Approve with minor suggestions**

---

## Strengths

1. **Clean architecture** — `models.py` (58 lines), `loaders.py` (663 lines), `render.py` (646 lines) with clear separation of concerns
2. **Type-safe models** — Frozen dataclasses with `slots=True`
3. **Resilient parsing** — Prefix-matching status normalization, multiple metadata format handling, backtick stripping, graceful fallbacks with warnings
4. **Deduplication logic** — Active quests are excluded if they already have journal entries, preventing dual-section appearance
5. **Comprehensive tests** — 15 loader unit tests, 11 render unit tests, 3 integration tests, all covering real edge cases
6. **Self-contained output** — No CDN, no JS, no external CSS — works offline
7. **Good HTML escaping** — `_escape_html()` on all user-facing content in `render.py`

---

## Issues

### Must-Fix

None — the code is functionally correct and tests pass.

### Should-Fix

1. **`_escape_html` reimplements `html.escape`** (`render.py:568-583`)
   Python stdlib has `html.escape()` which handles the same characters. The custom implementation isn't wrong, but using stdlib is more reliable and conventional:
   ```python
   import html
   # Replace _escape_html with html.escape
   ```

2. **`detect_github_url` returns `str` but `load_dashboard_data` signature says `str | None`** (`loaders.py:230`, `loaders.py:40`)
   `detect_github_url` returns `""` on failure, but the `github_url` parameter is typed `str | None`. The code works because `if github_url` is falsy for both `None` and `""`, but the mixed convention is confusing. Pick one: either return `None` for "no URL" or accept only `str`.

3. **`sys.path` manipulation in `build_quest_dashboard.py:21`**
   ```python
   sys.path.insert(0, str(Path(__file__).resolve().parents[1]))
   ```
   This is the same as what `conftest.py` does for tests. Consider adding a `pyproject.toml` or `setup.cfg` with a package declaration so the package is properly installable, or at minimum document that the script must be run from the repo root.

### Nit / Consider

4. **Journal index ordering** (`docs/quest-journal/README.md:10-11`)
   The new entries are inserted between the 2026-02-11 and 2026-02-09 rows, which maintains chronological order — good. But the `dashboard-final-implementation` (abandoned) appears before `dashboard-v2` (completed). Since they share the same date, this is fine, but worth noting for consistency.

5. **`_extract_first_paragraph` skips lines starting with `**` metadata** (`loaders.py:371-375`)
   The regex `r"\*\*[^*]+:\s*\*\*"` for detecting metadata lines would also match bold text in normal prose that happens to contain a colon. This is unlikely to cause problems in practice with quest journals but is theoretically fragile.

6. **1,488-line analysis document** (`ideas/quest-dashboard-analysis-and-plan.md`)
   This is a thorough reference doc, but at nearly 1,500 lines it significantly inflates the PR diff. Consider whether it belongs in the repo permanently or if the key insights should be distilled into a shorter document.

7. **`_normalize_display_label` is naive** (`loaders.py:566-573`)
   `raw_value.replace("_", " ").title()` converts `"code_review"` → `"Code Review"` which is fine, but would also convert `"PR"` → `"Pr"`. Not a problem today but something to be aware of.

8. **Generated `index.html` is checked in** (`docs/dashboard/index.html`)
   This is a generated artifact. Consider adding a comment at the top of the file (e.g., `<!-- AUTO-GENERATED by scripts/quest_dashboard/build_quest_dashboard.py — do not edit -->`) or adding it to `.gitignore` and generating it in CI.

9. **Allowlist changes are unrelated** (`.ai/allowlist.json`)
   The `model_overrides` and `gh pr view` permission additions are configuration changes bundled with the dashboard feature. Consider splitting into a separate commit for clarity.

10. **SKILL.md change is tangential** (`.skills/quest/SKILL.md`)
    The change from "Suggest a slug...and confirm" to "Generate a slug...and inform" is a behavior change to the quest system, not dashboard-related. Should probably be a separate commit.

---

## Security

No concerns. All user-facing text is HTML-escaped. No dynamic script injection. The `subprocess` calls for git operations use explicit argument lists (not shell=True) and have timeouts.

---

## Summary

Solid implementation with clean architecture, good test coverage, and proper HTML escaping. The main suggestions are: use `html.escape()` instead of the hand-rolled version, clean up the `str | None` vs `""` type inconsistency for GitHub URLs, and consider splitting the unrelated allowlist/SKILL.md changes into separate commits. The 1,488-line analysis doc is good reference material but may want to be trimmed for long-term maintenance.
